# üéØ –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞

## üìä –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –ê–õ–ì–û–†–ò–¢–ú–ê

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- –ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–æ –ø–æ–ª—É (`lookingFor`)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (`ageRange`)
- –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
- –û—á–µ—Ä–µ–¥—å –≤ Redis –¥–ª—è –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥–∞
- –ë–∞–∑–æ–≤—ã–µ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### ‚ùå –ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:
- **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è** - –Ω–µ—Ç —É—á–µ—Ç–∞ –≥–æ—Ä–æ–¥–∞/—Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
- **–í–µ—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞** - –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Å—á–µ—Ç –æ–±—â–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
- **–ú–µ—Ç–æ–¥ `getMatchmakingUsers`** - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ User –º–æ–¥–µ–ª–∏
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏** - –Ω–µ—Ç —É—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–Ω–ª–∞–π–Ω–∞
- **–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ** - –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è

---

## üéØ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ê–õ–ì–û–†–ò–¢–ú–£ –ü–û–î–ë–û–†–ê

### üìã –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–¥–±–æ—Ä–∞:
1. **–í–æ–∑—Ä–∞—Å—Ç** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–Ω–æ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É
2. **–ì–æ—Ä–æ–¥** - –±–ª–∏–∑–æ—Å—Ç—å –ø–æ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
3. **–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è** - —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
4. **–ü–æ–ª** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≥–µ–Ω–¥–µ—Ä–Ω—ã–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º
5. **–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–Ω–ª–∞–π–Ω–∞
6. **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –æ–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è

### üéØ –¶–µ–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞:
- **–¢–æ—á–Ω–æ—Å—Ç—å** - –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
- **–°–∫–æ—Ä–æ—Å—Ç—å** - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ (–¥–æ 2 —Å–µ–∫—É–Ω–¥)
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å** - —Ä–∞–≤–Ω—ã–µ —à–∞–Ω—Å—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üîß –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### üìã –≠—Ç–∞–ø 1: –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (1 –¥–µ–Ω—å)

#### 1.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```sql
-- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
ALTER TABLE users ADD COLUMN latitude DECIMAL(10, 8);
ALTER TABLE users ADD COLUMN longitude DECIMAL(11, 8);
ALTER TABLE users ADD COLUMN search_radius INTEGER DEFAULT 50;
ALTER TABLE users ADD COLUMN last_online TIMESTAMP DEFAULT NOW();
ALTER TABLE users ADD COLUMN preferences JSONB DEFAULT '{}';

-- –°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_users_location ON users(latitude, longitude);
CREATE INDEX idx_users_age_gender ON users(age, gender);
CREATE INDEX idx_users_interests ON users USING GIN(interests);
CREATE INDEX idx_users_online ON users(last_online) WHERE is_online = true;
CREATE INDEX idx_users_search ON users(latitude, longitude, age, gender, is_online);

-- –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–ª—è –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
CREATE EXTENSION IF NOT EXISTS postgis;
```

#### 1.2 –°–æ–∑–¥–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
```javascript
// backend/src/utils/geolocation.js
const axios = require('axios');

class GeolocationService {
  constructor() {
    this.apiKey = process.env.GOOGLE_MAPS_API_KEY;
    this.baseUrl = 'https://maps.googleapis.com/maps/api/geocode/json';
  }

  // –ì–µ–æ–∫–æ–¥–∏–Ω–≥ –∞–¥—Ä–µ—Å–∞ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
  async geocodeAddress(address) {
    try {
      const response = await axios.get(this.baseUrl, {
        params: {
          address,
          key: this.apiKey
        }
      });

      if (response.data.results.length > 0) {
        const location = response.data.results[0].geometry.location;
        return {
          latitude: location.lat,
          longitude: location.lng
        };
      }
      
      throw new Error('Address not found');
    } catch (error) {
      console.error('Geocoding error:', error);
      throw new Error('Failed to geocode address');
    }
  }

  // –†–∞—Å—á–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ (—Ñ–æ—Ä–º—É–ª–∞ –≥–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞)
  calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö
    const dLat = this.toRadians(lat2 - lat1);
    const dLon = this.toRadians(lon2 - lon1);
    
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(this.toRadians(lat1)) * Math.cos(this.toRadians(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  toRadians(degrees) {
    return degrees * (Math.PI / 180);
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–æ—á–∫–∞ –≤ —Ä–∞–¥–∏—É—Å–µ
  isWithinRadius(lat1, lon1, lat2, lon2, radiusKm) {
    const distance = this.calculateDistance(lat1, lon1, lat2, lon2);
    return distance <= radiusKm;
  }
}

module.exports = new GeolocationService();
```

### üìã –≠—Ç–∞–ø 2: –°–∏—Å—Ç–µ–º–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (1 –¥–µ–Ω—å)

#### 2.1 –°–æ–∑–¥–∞–Ω–∏–µ —É—Ç–∏–ª–∏—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
```javascript
// backend/src/utils/compatibility.js
const geolocationService = require('./geolocation');

class CompatibilityService {
  // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  calculateCompatibilityScore(user1, user2) {
    let totalScore = 0;
    let weights = 0;

    // –í–µ—Å –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º (40%)
    const interestScore = this.calculateInterestCompatibility(user1.interests, user2.interests);
    totalScore += interestScore * 0.4;
    weights += 0.4;

    // –í–µ—Å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É (25%)
    const ageScore = this.calculateAgeCompatibility(user1.age, user2.age);
    totalScore += ageScore * 0.25;
    weights += 0.25;

    // –í–µ—Å –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é (20%)
    const distanceScore = this.calculateDistanceCompatibility(user1, user2);
    totalScore += distanceScore * 0.2;
    weights += 0.2;

    // –í–µ—Å –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (15%)
    const activityScore = this.calculateActivityCompatibility(user1, user2);
    totalScore += activityScore * 0.15;
    weights += 0.15;

    return Math.round((totalScore / weights) * 100);
  }

  // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º
  calculateInterestCompatibility(interests1, interests2) {
    if (!interests1 || !interests2 || interests1.length === 0 || interests2.length === 0) {
      return 0;
    }

    const commonInterests = interests1.filter(interest => 
      interests2.includes(interest)
    );

    const totalInterests = Math.max(interests1.length, interests2.length);
    const baseScore = commonInterests.length / totalInterests;

    // –ë–æ–Ω—É—Å –∑–∞ –±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—â–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
    const bonus = Math.min(commonInterests.length * 0.1, 0.3);
    
    return Math.min(baseScore + bonus, 1.0);
  }

  // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
  calculateAgeCompatibility(age1, age2) {
    const ageDiff = Math.abs(age1 - age2);
    
    if (ageDiff <= 2) return 1.0;
    if (ageDiff <= 5) return 0.9;
    if (ageDiff <= 10) return 0.7;
    if (ageDiff <= 15) return 0.5;
    if (ageDiff <= 20) return 0.3;
    return 0.1;
  }

  // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
  calculateDistanceCompatibility(user1, user2) {
    if (!user1.latitude || !user1.longitude || !user2.latitude || !user2.longitude) {
      return 0.5; // –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –µ—Å–ª–∏ –Ω–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    }

    const distance = geolocationService.calculateDistance(
      user1.latitude, user1.longitude,
      user2.latitude, user2.longitude
    );

    const maxDistance = Math.min(user1.search_radius || 50, user2.search_radius || 50);
    
    if (distance <= maxDistance * 0.2) return 1.0; // –û—á–µ–Ω—å –±–ª–∏–∑–∫–æ
    if (distance <= maxDistance * 0.4) return 0.9;
    if (distance <= maxDistance * 0.6) return 0.7;
    if (distance <= maxDistance * 0.8) return 0.5;
    if (distance <= maxDistance) return 0.3;
    return 0.1; // –°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ
  }

  // –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
  calculateActivityCompatibility(user1, user2) {
    const now = new Date();
    const lastOnline1 = new Date(user1.last_online || now);
    const lastOnline2 = new Date(user2.last_online || now);

    const hoursSinceOnline1 = (now - lastOnline1) / (1000 * 60 * 60);
    const hoursSinceOnline2 = (now - lastOnline2) / (1000 * 60 * 60);

    // –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    const activityScore1 = Math.max(0, 1 - (hoursSinceOnline1 / 24));
    const activityScore2 = Math.max(0, 1 - (hoursSinceOnline2 / 24));

    return (activityScore1 + activityScore2) / 2;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
  isBasicCompatible(user1, user2) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –ø–æ–ª—É
    if (user1.lookingFor && user1.lookingFor !== 'both' && user1.lookingFor !== user2.gender) {
      return false;
    }
    if (user2.lookingFor && user2.lookingFor !== 'both' && user2.lookingFor !== user1.gender) {
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
    if (user1.ageRange) {
      if (user2.age < user1.ageRange.min || user2.age > user1.ageRange.max) {
        return false;
      }
    }
    if (user2.ageRange) {
      if (user1.age < user2.ageRange.min || user1.age > user2.ageRange.max) {
        return false;
      }
    }

    return true;
  }
}

module.exports = new CompatibilityService();
```

### üìã –≠—Ç–∞–ø 3: –ú–µ—Ç–æ–¥ getMatchmakingUsers (1 –¥–µ–Ω—å)

#### 3.1 –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ User –º–æ–¥–µ–ª–∏
```javascript
// backend/src/models/User.js - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥
static async getMatchmakingUsers(currentUserId, preferences) {
  const {
    lookingFor,
    interests,
    ageRange,
    maxDistance = 50,
    limit = 20
  } = preferences;

  const currentUser = await this.findById(currentUserId);
  if (!currentUser) {
    throw new Error('User not found');
  }

  // –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏
  let query = `
    SELECT 
      u.*,
      CASE 
        WHEN u.latitude IS NOT NULL AND u.longitude IS NOT NULL 
          AND $1 IS NOT NULL AND $2 IS NOT NULL
        THEN ST_Distance(
          ST_MakePoint(u.longitude, u.latitude)::geography,
          ST_MakePoint($1, $2)::geography
        ) / 1000
        ELSE NULL
      END as distance_km,
      CASE 
        WHEN u.interests && $3 THEN 
          array_length(array(
            SELECT unnest(u.interests) 
            INTERSECT 
            SELECT unnest($3)
          ), 1)::float / 
          GREATEST(array_length(u.interests, 1), array_length($3, 1))
        ELSE 0
      END as interest_overlap
    FROM users u
    WHERE u.id != $4
    AND u.is_online = true
    AND u.last_online >= NOW() - INTERVAL '30 minutes'
  `;

  const params = [
    currentUser.longitude,
    currentUser.latitude,
    interests,
    currentUserId
  ];
  let paramIndex = 5;

  // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—É
  if (lookingFor && lookingFor !== 'both') {
    query += ` AND u.gender = $${paramIndex}`;
    params.push(lookingFor);
    paramIndex++;
  }

  // –§–∏–ª—å—Ç—Ä –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
  if (ageRange) {
    query += ` AND u.age BETWEEN $${paramIndex} AND $${paramIndex + 1}`;
    params.push(ageRange.min, ageRange.max);
    paramIndex += 2;
  }

  // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è)
  if (currentUser.latitude && currentUser.longitude) {
    query += ` AND ST_Distance(
      ST_MakePoint(u.longitude, u.latitude)::geography,
      ST_MakePoint($1, $2)::geography
    ) <= $${paramIndex} * 1000`;
    params.push(maxDistance);
    paramIndex++;
  }

  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
  query += `
    ORDER BY 
      interest_overlap DESC,
      distance_km ASC NULLS LAST,
      u.last_online DESC
    LIMIT $${paramIndex}
  `;
  
  params.push(limit);

  try {
    const result = await pool.query(query, params);
    return result.rows;
  } catch (error) {
    console.error('getMatchmakingUsers error:', error);
    throw new Error('Failed to get matchmaking users');
  }
}

// –ú–µ—Ç–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
static async updateLocation(userId, latitude, longitude) {
  try {
    const query = `
      UPDATE users 
      SET latitude = $2, longitude = $3, updated_at = NOW()
      WHERE id = $1
      RETURNING id, latitude, longitude
    `;
    
    const result = await pool.query(query, [userId, latitude, longitude]);
    return result.rows[0];
  } catch (error) {
    throw new Error(`Error updating user location: ${error.message}`);
  }
}

// –ú–µ—Ç–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–∏—Å–∫–∞
static async updateSearchPreferences(userId, preferences) {
  try {
    const { searchRadius, ageRange, lookingFor } = preferences;
    
    const query = `
      UPDATE users 
      SET 
        search_radius = COALESCE($2, search_radius),
        preferences = COALESCE($3, preferences),
        updated_at = NOW()
      WHERE id = $1
      RETURNING id, search_radius, preferences
    `;
    
    const preferencesJson = JSON.stringify({
      ageRange,
      lookingFor,
      ...preferences
    });
    
    const result = await pool.query(query, [userId, searchRadius, preferencesJson]);
    return result.rows[0];
  } catch (error) {
    throw new Error(`Error updating search preferences: ${error.message}`);
  }
}
```

### üìã –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥–∞ (1 –¥–µ–Ω—å)

#### 4.1 –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞
```javascript
// backend/src/controllers/matchmakingController.js
const User = require('../models/User');
const redis = require('../config/redis');
const compatibilityService = require('../utils/compatibility');
const geolocationService = require('../utils/geolocation');

// –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
const findMatch = async (req, res) => {
  try {
    const userId = req.user.id;
    const { 
      lookingFor, 
      ageRange, 
      interests, 
      maxDistance = 50,
      limit = 5 
    } = req.body;

    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    const potentialMatches = await User.getMatchmakingUsers(userId, {
      lookingFor,
      interests,
      ageRange,
      maxDistance,
      limit: 20 // –ü–æ–ª—É—á–∞–µ–º –±–æ–ª—å—à–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤—ã–±–æ—Ä–∞
    });

    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
    const matchesWithScore = potentialMatches.map(match => ({
      ...match,
      compatibility: compatibilityService.calculateCompatibilityScore(
        { ...req.user, interests, ageRange },
        match
      )
    }));

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    matchesWithScore.sort((a, b) => b.compatibility - a.compatibility);

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    const topMatches = matchesWithScore.slice(0, limit);

    res.json({
      matches: topMatches,
      totalFound: matchesWithScore.length,
      searchRadius: maxDistance,
      userLocation: {
        latitude: req.user.latitude,
        longitude: req.user.longitude
      }
    });
  } catch (error) {
    console.error('Find match error:', error);
    res.status(500).json({
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π',
      message: error.message
    });
  }
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const updateLocation = async (req, res) => {
  try {
    const userId = req.user.id;
    const { latitude, longitude, address } = req.body;

    let coords = { latitude, longitude };

    // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∞–¥—Ä–µ—Å, –≥–µ–æ–∫–æ–¥–∏–º –µ–≥–æ
    if (address && (!latitude || !longitude)) {
      coords = await geolocationService.geocodeAddress(address);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const updatedUser = await User.updateLocation(userId, coords.latitude, coords.longitude);

    res.json({
      message: '–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞',
      location: {
        latitude: updatedUser.latitude,
        longitude: updatedUser.longitude
      }
    });
  } catch (error) {
    console.error('Update location error:', error);
    res.status(500).json({
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏',
      message: error.message
    });
  }
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–∏—Å–∫–∞
const updateSearchPreferences = async (req, res) => {
  try {
    const userId = req.user.id;
    const { searchRadius, ageRange, lookingFor, interests } = req.body;

    const updatedUser = await User.updateSearchPreferences(userId, {
      searchRadius,
      ageRange,
      lookingFor,
      interests
    });

    res.json({
      message: '–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã',
      preferences: updatedUser.preferences,
      searchRadius: updatedUser.search_radius
    });
  } catch (error) {
    console.error('Update search preferences error:', error);
    res.status(500).json({
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π',
      message: error.message
    });
  }
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∏—Å–∫–∞
const getSearchStats = async (req, res) => {
  try {
    const userId = req.user.id;
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ä–µ–≥–∏–æ–Ω—É
    const user = await User.findById(userId);
    if (!user.latitude || !user.longitude) {
      return res.json({
        nearbyUsers: 0,
        totalOnline: 0,
        averageDistance: null
      });
    }

    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–¥–∏—É—Å–µ
    const nearbyUsers = await User.getMatchmakingUsers(userId, {
      maxDistance: user.search_radius || 50,
      limit: 1000
    });

    const totalOnline = await User.getStats();

    res.json({
      nearbyUsers: nearbyUsers.length,
      totalOnline: totalOnline.total_users,
      averageDistance: nearbyUsers.length > 0 
        ? nearbyUsers.reduce((sum, user) => sum + (user.distance_km || 0), 0) / nearbyUsers.length
        : null,
      searchRadius: user.search_radius || 50
    });
  } catch (error) {
    console.error('Get search stats error:', error);
    res.status(500).json({
      error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
      message: error.message
    });
  }
};

module.exports = {
  joinQueue,
  leaveQueue,
  findMatch,
  getQueueStatus,
  getOnlineUsers,
  updateLocation,
  updateSearchPreferences,
  getSearchStats
};
```

### üìã –≠—Ç–∞–ø 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ—É—Ç–æ–≤ (0.5 –¥–Ω—è)

#### 5.1 –ù–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
```javascript
// backend/src/routes/matchmaking.js
const express = require('express');
const router = express.Router();
const auth = require('../middleware/auth');
const { matchmakingValidation } = require('../middleware/validation');
const {
  joinQueue,
  leaveQueue,
  findMatch,
  getQueueStatus,
  getOnlineUsers,
  updateLocation,
  updateSearchPreferences,
  getSearchStats
} = require('../controllers/matchmakingController');

// –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ä–æ—É—Ç—ã
router.post('/join', auth, matchmakingValidation, joinQueue);
router.post('/leave', auth, leaveQueue);
router.post('/find', auth, matchmakingValidation, findMatch);
router.get('/status', auth, getQueueStatus);
router.get('/online', auth, getOnlineUsers);

// –ù–æ–≤—ã–µ —Ä–æ—É—Ç—ã –¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π
router.post('/location', auth, updateLocation);
router.post('/preferences', auth, updateSearchPreferences);
router.get('/stats', auth, getSearchStats);

module.exports = router;
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ê–õ–ì–û–†–ò–¢–ú–ê

### üìã Unit —Ç–µ—Å—Ç—ã
```javascript
// backend/src/tests/matchmaking.test.js
const request = require('supertest');
const app = require('../server');
const User = require('../models/User');
const compatibilityService = require('../utils/compatibility');

describe('Matchmaking Algorithm', () => {
  let testUser1, testUser2, testUser3;

  beforeEach(async () => {
    // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    testUser1 = await User.create({
      email: 'user1@test.com',
      password: 'password123',
      name: 'User 1',
      age: 25,
      gender: 'male',
      location: 'Moscow',
      interests: ['–ú—É–∑—ã–∫–∞', '–°–ø–æ—Ä—Ç', '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'],
      latitude: 55.7558,
      longitude: 37.6176
    });

    testUser2 = await User.create({
      email: 'user2@test.com',
      password: 'password123',
      name: 'User 2',
      age: 23,
      gender: 'female',
      location: 'Moscow',
      interests: ['–ú—É–∑—ã–∫–∞', '–ö–∏–Ω–æ', '–ö–Ω–∏–≥–∏'],
      latitude: 55.7558,
      longitude: 37.6176
    });

    testUser3 = await User.create({
      email: 'user3@test.com',
      password: 'password123',
      name: 'User 3',
      age: 30,
      gender: 'female',
      location: 'Saint Petersburg',
      interests: ['–°–ø–æ—Ä—Ç', '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'],
      latitude: 59.9311,
      longitude: 30.3609
    });
  });

  test('should find compatible matches based on interests', async () => {
    const response = await request(app)
      .post('/api/matchmaking/find')
      .set('Authorization', `Bearer ${testUser1.token}`)
      .send({
        lookingFor: 'female',
        ageRange: { min: 20, max: 30 },
        interests: ['–ú—É–∑—ã–∫–∞', '–°–ø–æ—Ä—Ç'],
        maxDistance: 100
      });

    expect(response.status).toBe(200);
    expect(response.body.matches).toHaveLength(2);
    expect(response.body.matches[0].compatibility).toBeGreaterThan(50);
  });

  test('should filter by distance correctly', async () => {
    const response = await request(app)
      .post('/api/matchmaking/find')
      .set('Authorization', `Bearer ${testUser1.token}`)
      .send({
        lookingFor: 'female',
        ageRange: { min: 20, max: 30 },
        interests: ['–ú—É–∑—ã–∫–∞', '–°–ø–æ—Ä—Ç'],
        maxDistance: 10 // –¢–æ–ª—å–∫–æ –ú–æ—Å–∫–≤–∞
      });

    expect(response.status).toBe(200);
    expect(response.body.matches).toHaveLength(1); // –¢–æ–ª—å–∫–æ user2
    expect(response.body.matches[0].name).toBe('User 2');
  });
});
```

---

## üìä –ú–ï–¢–†–ò–ö–ò –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì

### üìà –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
1. **–í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞** - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å < 2 —Å–µ–∫—É–Ω–¥
2. **–ö–∞—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π** - —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
3. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π** - —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** - —Å—Ä–µ–¥–Ω–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

### üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
```javascript
// backend/src/utils/metrics.js - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
const matchmakingDuration = new prometheus.Histogram({
  name: 'matchmaking_duration_seconds',
  help: 'Duration of matchmaking requests',
  labelNames: ['status']
});

const matchmakingCompatibility = new prometheus.Histogram({
  name: 'matchmaking_compatibility_score',
  help: 'Compatibility scores of matches',
  buckets: [0, 25, 50, 75, 90, 100]
});

const matchmakingDistance = new prometheus.Histogram({
  name: 'matchmaking_distance_km',
  help: 'Distance to matches in kilometers',
  buckets: [0, 5, 10, 25, 50, 100, 200]
});
```

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

### ‚úÖ –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
- **–¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–¥–±–æ—Ä–∞:** 85%+ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- **–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞:** < 2 —Å–µ–∫—É–Ω–¥—ã
- **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å:** —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 10,000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### üìä –£–ª—É—á—à–µ–Ω–∏—è:
- **–í 3 —Ä–∞–∑–∞** –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
- **–í 2 —Ä–∞–∑–∞** –±—ã—Å—Ç—Ä–µ–µ –ø–æ–∏—Å–∫
- **–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è** –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é
- **–í–µ—Å–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞** –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–î–∞–Ω–Ω—ã–π –ø–ª–∞–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–¥–±–æ—Ä–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π: –≤–æ–∑—Ä–∞—Å—Ç–∞, –≥–æ—Ä–æ–¥–∞, –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∏ –≥–µ–Ω–¥–µ—Ä–∞. –ê–ª–≥–æ—Ä–∏—Ç–º –±—É–¥–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–º, –±—ã—Å—Ç—Ä—ã–º –∏ —Ç–æ—á–Ω—ã–º.

**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 4-5 –¥–Ω–µ–π
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è 